/**
 * Malware Detection Patterns
 *
 * Comprehensive pattern library for detecting malware, viruses, spyware,
 * trojans, backdoors, cryptominers, and other malicious code.
 */

import type { ThreatPattern } from './types.js';

const jsTs = ['*.js', '*.ts', '*.jsx', '*.tsx', '*.mjs', '*.cjs'];
const allCode = [...jsTs, '*.py', '*.rb', '*.php', '*.sh', '*.bash'];
const config = ['*.json', '*.yaml', '*.yml', '*.toml', '*.xml'];

/**
 * Critical Threat Patterns - Immediate action required
 */
export const criticalPatterns: ThreatPattern[] = [
  // === BACKDOORS & REVERSE SHELLS ===
  {
    id: 'BACKDOOR-001',
    name: 'Reverse Shell Pattern',
    category: 'BACKDOOR',
    severity: 'CRITICAL',
    description: 'Code pattern indicating a reverse shell connection',
    pattern: /spawn\s*\(\s*['"`](sh|bash|cmd|powershell)['"`]/gi,
    fileTypes: allCode,
    falsePositiveHint: 'May be legitimate in DevOps/build tools'
  },
  {
    id: 'BACKDOOR-002',
    name: 'Network Shell Spawn',
    category: 'BACKDOOR',
    severity: 'CRITICAL',
    description: 'Network connection combined with shell process spawning',
    pattern: /net\.connect.*spawn|spawn.*net\.connect/gi,
    fileTypes: jsTs,
  },
  {
    id: 'BACKDOOR-003',
    name: 'Eval Remote Code',
    category: 'BACKDOOR',
    severity: 'CRITICAL',
    description: 'Fetching and executing remote code',
    pattern: /eval\s*\(\s*(await\s+)?fetch|eval\s*\(\s*require\s*\(\s*['"`]https?/gi,
    fileTypes: jsTs,
  },
  {
    id: 'BACKDOOR-004',
    name: 'WebSocket Backdoor',
    category: 'BACKDOOR',
    severity: 'CRITICAL',
    description: 'WebSocket connection with command execution',
    pattern: /WebSocket.*exec|exec.*WebSocket/gi,
    fileTypes: jsTs,
  },

  // === DATA EXFILTRATION ===
  {
    id: 'EXFIL-001',
    name: 'SSH Key Access',
    category: 'DATA_EXFILTRATION',
    severity: 'CRITICAL',
    description: 'Accessing SSH private keys',
    pattern: /readFile.*\.ssh\/(id_rsa|id_ed25519|id_ecdsa)|\.ssh\/(id_rsa|id_ed25519).*read/gi,
    fileTypes: allCode,
  },
  {
    id: 'EXFIL-002',
    name: 'AWS Credential Access',
    category: 'DATA_EXFILTRATION',
    severity: 'CRITICAL',
    description: 'Accessing AWS credentials or config',
    pattern: /readFile.*\.aws\/(credentials|config)|\.aws\/credentials.*read/gi,
    fileTypes: allCode,
  },
  {
    id: 'EXFIL-003',
    name: 'Environment Variable Exfil',
    category: 'DATA_EXFILTRATION',
    severity: 'CRITICAL',
    description: 'Sending environment variables to external server',
    pattern: /fetch.*process\.env|axios.*process\.env|http.*process\.env/gi,
    fileTypes: jsTs,
  },

  // === RANSOMWARE ===
  {
    id: 'RANSOM-001',
    name: 'Mass File Encryption',
    category: 'RANSOMWARE',
    severity: 'CRITICAL',
    description: 'Pattern suggesting mass file encryption',
    pattern: /readdirSync.*encrypt.*writeFile|forEach.*crypto\.(public)?Encrypt/gi,
    fileTypes: jsTs,
  },
  {
    id: 'RANSOM-002',
    name: 'Ransom Note Creation',
    category: 'RANSOMWARE',
    severity: 'CRITICAL',
    description: 'Creating ransom note files',
    pattern: /writeFile.*(README.*DECRYPT|RECOVERY|RANSOM|YOUR_FILES)/gi,
    fileTypes: allCode,
  },
];

/**
 * High Severity Patterns - Should be investigated
 */
export const highPatterns: ThreatPattern[] = [
  // === SPYWARE & KEYLOGGERS ===
  {
    id: 'SPYWARE-001',
    name: 'Keylogger Pattern',
    category: 'KEYLOGGER',
    severity: 'HIGH',
    description: 'Keyboard event capture with data transmission',
    pattern: /addEventListener\s*\(\s*['"`]key(down|up|press)['"`].*send|on\s*\(\s*['"`]keypress['"`]/gi,
    fileTypes: jsTs,
  },
  {
    id: 'SPYWARE-002',
    name: 'Clipboard Monitoring',
    category: 'SPYWARE',
    severity: 'HIGH',
    description: 'Reading clipboard contents',
    pattern: /clipboard\.(readText|read)|navigator\.clipboard\.read/gi,
    fileTypes: jsTs,
    falsePositiveHint: 'May be legitimate clipboard functionality'
  },
  {
    id: 'SPYWARE-003',
    name: 'Screen Capture',
    category: 'SPYWARE',
    severity: 'HIGH',
    description: 'Screen capture or recording functionality',
    pattern: /getDisplayMedia|screenshot-desktop|desktopCapturer/gi,
    fileTypes: jsTs,
    falsePositiveHint: 'May be legitimate in screen sharing/recording apps'
  },

  // === CRYPTOMINERS ===
  {
    id: 'MINER-001',
    name: 'Mining Pool Connection',
    category: 'CRYPTOMINER',
    severity: 'HIGH',
    description: 'Connection to cryptocurrency mining pool',
    pattern: /stratum\+tcp:\/\/|stratum:\/\/|mining.*pool/gi,
    fileTypes: allCode,
  },
  {
    id: 'MINER-002',
    name: 'Known Miner Libraries',
    category: 'CRYPTOMINER',
    severity: 'HIGH',
    description: 'Known cryptominer library references',
    pattern: /coinhive|cryptoloot|deepMiner|coin-hive|crypto-loot/gi,
    fileTypes: [...allCode, ...config],
  },
  {
    id: 'MINER-003',
    name: 'WebAssembly Crypto',
    category: 'CRYPTOMINER',
    severity: 'HIGH',
    description: 'WebAssembly with cryptographic mining patterns',
    pattern: /WebAssembly\.(instantiate|Module).*hash|wasm.*cryptonight|wasm.*scrypt/gi,
    fileTypes: jsTs,
  },

  // === OBFUSCATION ===
  {
    id: 'OBFUSC-001',
    name: 'Hex Variable Obfuscation',
    category: 'OBFUSCATION',
    severity: 'HIGH',
    description: 'Heavy use of hex-named variables indicating obfuscation',
    pattern: /var\s+_0x[a-f0-9]+\s*=|const\s+_0x[a-f0-9]+\s*=/gi,
    fileTypes: jsTs,
  },
  {
    id: 'OBFUSC-002',
    name: 'Packed JavaScript',
    category: 'OBFUSCATION',
    severity: 'HIGH',
    description: 'Packed/compressed JavaScript with eval',
    pattern: /eval\s*\(\s*function\s*\(\s*p\s*,\s*a\s*,\s*c\s*,\s*k\s*,\s*e\s*,\s*[dr]\s*\)/gi,
    fileTypes: jsTs,
  },
  {
    id: 'OBFUSC-003',
    name: 'String.fromCharCode Array',
    category: 'OBFUSCATION',
    severity: 'HIGH',
    description: 'Building strings from char codes to hide content',
    pattern: /String\.fromCharCode\s*\(\s*\d+\s*(,\s*\d+){5,}/gi,
    fileTypes: jsTs,
  },

  // === PRIVILEGE ESCALATION ===
  {
    id: 'PRIVESC-001',
    name: 'Sudoers Modification',
    category: 'PRIVILEGE_ESCALATION',
    severity: 'HIGH',
    description: 'Attempting to modify sudoers file',
    pattern: /\/etc\/sudoers|NOPASSWD.*ALL/gi,
    fileTypes: allCode,
  },
  {
    id: 'PRIVESC-002',
    name: 'SetUID Manipulation',
    category: 'PRIVILEGE_ESCALATION',
    severity: 'HIGH',
    description: 'Setting SetUID bit on files',
    pattern: /chmod.*4[0-7]{3}|chmodSync.*0o4/gi,
    fileTypes: allCode,
  },

  // === PERSISTENCE ===
  {
    id: 'PERSIST-001',
    name: 'Cron Job Creation',
    category: 'PERSISTENCE',
    severity: 'HIGH',
    description: 'Creating cron jobs for persistence',
    pattern: /\/etc\/cron\.|crontab\s+-|writeFile.*cron/gi,
    fileTypes: allCode,
    falsePositiveHint: 'May be legitimate scheduled task setup'
  },
  {
    id: 'PERSIST-002',
    name: 'Systemd Service Creation',
    category: 'PERSISTENCE',
    severity: 'HIGH',
    description: 'Creating systemd services',
    pattern: /systemctl\s+enable|\.service.*WantedBy|writeFile.*\/etc\/systemd/gi,
    fileTypes: allCode,
    falsePositiveHint: 'May be legitimate service installation'
  },
  {
    id: 'PERSIST-003',
    name: 'Windows Registry Run Key',
    category: 'PERSISTENCE',
    severity: 'HIGH',
    description: 'Adding to Windows startup registry',
    pattern: /CurrentVersion\\Run|HKLM.*Run\s/gi,
    fileTypes: allCode,
  },
];

/**
 * Medium Severity Patterns - Worth reviewing
 */
export const mediumPatterns: ThreatPattern[] = [
  // === INJECTION RISKS ===
  {
    id: 'INJECT-001',
    name: 'Dynamic Eval',
    category: 'INJECTION',
    severity: 'MEDIUM',
    description: 'Eval with dynamic content',
    pattern: /eval\s*\([^)]*\+|eval\s*\(\s*`/gi,
    fileTypes: jsTs,
    falsePositiveHint: 'May be legitimate in template engines'
  },
  {
    id: 'INJECT-002',
    name: 'Dynamic Require/Import',
    category: 'INJECTION',
    severity: 'MEDIUM',
    description: 'Dynamic module loading with variables',
    pattern: /require\s*\(\s*[^'"`\s][^)]*\)|import\s*\(\s*[^'"`]/gi,
    fileTypes: jsTs,
    falsePositiveHint: 'May be legitimate dynamic imports'
  },
  {
    id: 'INJECT-003',
    name: 'Function Constructor',
    category: 'INJECTION',
    severity: 'MEDIUM',
    description: 'Using Function constructor to execute code',
    pattern: /new\s+Function\s*\(/gi,
    fileTypes: jsTs,
  },

  // === SUSPICIOUS NETWORK ===
  {
    id: 'NET-001',
    name: 'Hardcoded IP Address',
    category: 'BACKDOOR',
    severity: 'MEDIUM',
    description: 'Hardcoded IP address in network calls',
    pattern: /(?:https?:\/\/|connect\s*\(\s*['"`])\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/gi,
    fileTypes: allCode,
    falsePositiveHint: 'May be legitimate local/test IPs'
  },
  {
    id: 'NET-002',
    name: 'Base64 Encoded URL',
    category: 'OBFUSCATION',
    severity: 'MEDIUM',
    description: 'Base64 encoded URLs or payloads',
    pattern: /atob\s*\(\s*['"`][A-Za-z0-9+/]{20,}|Buffer\.from\s*\([^,]+,\s*['"`]base64['"`]\)/gi,
    fileTypes: jsTs,
  },

  // === SUPPLY CHAIN ===
  {
    id: 'SUPPLY-001',
    name: 'Postinstall Network Request',
    category: 'SUPPLY_CHAIN',
    severity: 'MEDIUM',
    description: 'Postinstall script making network requests',
    pattern: /"(pre|post)install"\s*:\s*"[^"]*curl|"(pre|post)install"\s*:\s*"[^"]*wget|"(pre|post)install"\s*:\s*"[^"]*fetch/gi,
    fileTypes: config,
  },
  {
    id: 'SUPPLY-002',
    name: 'Binary Download in Install',
    category: 'SUPPLY_CHAIN',
    severity: 'MEDIUM',
    description: 'Downloading binaries during installation',
    pattern: /"(pre|post)install"\s*:\s*"[^"]*\.exe|"(pre|post)install"\s*:\s*"[^"]*\.bin/gi,
    fileTypes: config,
  },
];

/**
 * Low Severity Patterns - Monitor but likely safe
 */
export const lowPatterns: ThreatPattern[] = [
  {
    id: 'INFO-001',
    name: 'Child Process Usage',
    category: 'INJECTION',
    severity: 'LOW',
    description: 'Use of child_process module',
    pattern: /require\s*\(\s*['"`]child_process['"`]\)|from\s+['"`]child_process['"`]/gi,
    fileTypes: jsTs,
    falsePositiveHint: 'Very common in Node.js tools'
  },
  {
    id: 'INFO-002',
    name: 'Environment Variable Access',
    category: 'DATA_EXFILTRATION',
    severity: 'LOW',
    description: 'Accessing environment variables',
    pattern: /process\.env\[|process\.env\./gi,
    fileTypes: jsTs,
    falsePositiveHint: 'Standard configuration pattern'
  },
  {
    id: 'INFO-003',
    name: 'File System Operations',
    category: 'DATA_EXFILTRATION',
    severity: 'LOW',
    description: 'File system read operations',
    pattern: /fs\.(readFile|readFileSync|readdir)/gi,
    fileTypes: jsTs,
    falsePositiveHint: 'Very common Node.js operation'
  },
];

/**
 * All patterns combined for comprehensive scanning
 */
export const allPatterns: ThreatPattern[] = [
  ...criticalPatterns,
  ...highPatterns,
  ...mediumPatterns,
  ...lowPatterns,
];

/**
 * Known typosquatted package patterns
 */
export const typosquatPatterns: string[] = [
  // Lodash variants
  'lodahs', 'lodassh', 'loadash', 'lodas',
  // Request variants
  'requst', 'requets', 'reqeust', 'requiest',
  // Express variants
  'expres', 'expresss', 'epxress',
  // Axios variants
  'axois', 'axiso', 'axio',
  // React variants
  'raect', 'reactt', 'recat',
  // Underscore variants
  'undescore', 'underscor', 'underscoree',
  // Babel variants
  'bable', 'babl', 'babael',
  // Webpack variants
  'webpck', 'wepback', 'webpackk',
  // Commander variants
  'comandar', 'comander', 'commandar',
  // Colors variants (known attack)
  'colorsss', 'colorss', 'colour', 'colrs',
  // Event-stream variants (known attack)
  'event-streem', 'eventstream', 'event_stream',
];

/**
 * Suspicious postinstall patterns
 */
export const suspiciousScripts = [
  /curl\s+.+\s*\|\s*sh/,
  /wget\s+.+\s*\|\s*sh/,
  /powershell\s+-enc/i,
  /bash\s+-c\s+.*http/,
  /node\s+-e\s+.*require.*http/,
];
